<!DOCTYPE html>
<html>
<head>
  <title>Direct Browser Test</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Testing Edge Function from Browser</h1>
  <button onclick="testFunction()">Test Generate Content Kit</button>
  <pre id="output"></pre>

  <script>
    const SUPABASE_URL = 'https://azrbnenohawcdawnxzat.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF6cmJuZW5vaGF3Y2Rhd254emF0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NTE4NzksImV4cCI6MjA3NzMyNzg3OX0.yycaVKnsig4fwbmyDlpXky656WkeLrBKuSINquQXWXI';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function testFunction() {
      const output = document.getElementById('output');
      output.textContent = 'Testing...\n';

      const voiceCard = JSON.stringify({
        "tone": "confident, direct, knowledgeable",
        "personality": "expert, transparent, trustworthy",
        "values": ["quality", "sustainability", "transparency", "convenience"],
        "style": "informative yet warm, professional but approachable",
        "languagePatterns": ["We believe in...", "Our commitment to...", "Experience the difference..."],
        "audience": "coffee enthusiasts who value quality and ethical sourcing"
      });

      const body = {
        voiceCard: voiceCard,
        trendTitle: "Short-Form Video Marketing",
        platforms: ["Instagram", "LinkedIn", "Twitter", "Facebook", "TikTok"],
        niche: "D2C Coffee Roaster"
      };

      output.textContent += 'Request body:\n' + JSON.stringify(body, null, 2) + '\n\n';
      output.textContent += 'Calling Edge Function via Supabase client...\n';

      try {
        const { data, error } = await supabase.functions.invoke('generate-content-kit', {
          body: body
        });

        if (error) {
          output.textContent += '\n❌ ERROR:\n';
          output.textContent += JSON.stringify(error, null, 2) + '\n';
          
          // Try to get more details
          console.error('Full error object:', error);
          console.error('Error context:', error.context);
          
          if (error.context) {
            try {
              const errorText = await error.context.text();
              output.textContent += '\nError response body:\n' + errorText + '\n';
            } catch (e) {
              output.textContent += '\nCould not read error response body\n';
            }
          }
        } else {
          output.textContent += '\n✅ SUCCESS:\n';
          output.textContent += JSON.stringify(data, null, 2) + '\n';
          output.textContent += `\nGenerated ${data.contentKits.length} content kits\n`;
        }
      } catch (err) {
        output.textContent += '\n❌ EXCEPTION:\n';
        output.textContent += err.message + '\n';
        output.textContent += err.stack + '\n';
        console.error('Exception:', err);
      }
    }
  </script>
</body>
</html>
